#!/bin/bash
#===============================================================================
# Hyperion CLI - Unified control for Hyperion message processing system
#
# Usage: hyperion <command> [options]
#
# Commands:
#   start       Start all Hyperion services
#   stop        Stop all Hyperion services
#   restart     Restart all Hyperion services
#   status      Show status of all components
#   attach      Attach to Claude tmux session
#   logs        Show logs (follow mode)
#   inbox       Check inbox for pending messages
#   outbox      Check outbox for pending replies
#   stats       Show message statistics
#   ps          List running Claude instances
#   test        Send a test message through the system
#   update      Update Hyperion (pull changes, restart services)
#   help        Show this help message
#===============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Directories
INBOX_DIR="$HOME/messages/inbox"
OUTBOX_DIR="$HOME/messages/outbox"
PROCESSED_DIR="$HOME/messages/processed"

# Services
SERVICES=("hyperion-router" "hyperion-claude")

#-------------------------------------------------------------------------------
# Helper Functions
#-------------------------------------------------------------------------------

print_header() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘  $1$(printf '%*s' $((53 - ${#1})) '')â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

service_status() {
    local service=$1
    if systemctl is-active --quiet "$service" 2>/dev/null; then
        echo -e "${GREEN}â—${NC} $service: ${GREEN}running${NC}"
        return 0
    else
        echo -e "${RED}â—‹${NC} $service: ${RED}stopped${NC}"
        return 1
    fi
}

count_files() {
    local dir=$1
    find "$dir" -name "*.json" -type f 2>/dev/null | wc -l
}

#-------------------------------------------------------------------------------
# Commands
#-------------------------------------------------------------------------------

cmd_start() {
    print_header "Starting Hyperion"

    for service in "${SERVICES[@]}"; do
        echo -n "Starting $service... "
        if sudo systemctl start "$service" 2>/dev/null; then
            echo -e "${GREEN}OK${NC}"
        else
            echo -e "${RED}FAILED${NC}"
        fi
    done

    sleep 2
    echo ""
    cmd_status
}

cmd_stop() {
    print_header "Stopping Hyperion"

    for service in "${SERVICES[@]}"; do
        echo -n "Stopping $service... "
        if sudo systemctl stop "$service" 2>/dev/null; then
            echo -e "${GREEN}OK${NC}"
        else
            echo -e "${YELLOW}not running${NC}"
        fi
    done
}

cmd_restart() {
    print_header "Restarting Hyperion"
    cmd_stop
    sleep 1
    cmd_start
}

cmd_status() {
    print_header "Hyperion Status"

    echo ""
    echo -e "${CYAN}Services:${NC}"
    local all_running=true
    for service in "${SERVICES[@]}"; do
        if ! service_status "$service"; then
            all_running=false
        fi
    done

    echo ""
    echo -e "${CYAN}Message Queues:${NC}"
    local inbox_count=$(count_files "$INBOX_DIR")
    local outbox_count=$(count_files "$OUTBOX_DIR")
    local processed_count=$(count_files "$PROCESSED_DIR")

    echo "  Inbox:     $inbox_count pending"
    echo "  Outbox:    $outbox_count queued"
    echo "  Processed: $processed_count total"

    echo ""
    echo -e "${CYAN}MCP Servers:${NC}"
    claude mcp list 2>/dev/null | grep -E "hyperion|telegram" | sed 's/^/  /' || echo "  (run 'claude mcp list' to check)"

    echo ""
    if $all_running; then
        echo -e "${GREEN}âœ“ Hyperion is operational${NC}"
    else
        echo -e "${YELLOW}âš  Some services are not running${NC}"
    fi
}

cmd_logs() {
    local service="${1:-all}"

    print_header "Hyperion Logs"

    if [ "$service" = "all" ]; then
        echo "Showing logs for all services (Ctrl+C to exit)..."
        echo ""
        sudo journalctl -u hyperion-router -u hyperion-claude -f --no-pager
    elif [ "$service" = "bot" ] || [ "$service" = "router" ]; then
        sudo journalctl -u hyperion-router -f --no-pager
    elif [ "$service" = "claude" ]; then
        echo "Claude runs in tmux. Use 'hyperion attach' to view live session."
        echo "Showing systemd logs for hyperion-claude service..."
        echo ""
        sudo journalctl -u hyperion-claude -f --no-pager
    else
        echo "Unknown service: $service"
        echo "Usage: hyperion logs [all|bot|claude]"
    fi
}

cmd_attach() {
    print_header "Attaching to Claude Session"

    if tmux -L hyperion has-session -t hyperion 2>/dev/null; then
        echo "Attaching to hyperion tmux session..."
        echo "Press Ctrl+B, D to detach without stopping Claude."
        echo ""
        tmux -L hyperion attach-session -t hyperion
    else
        echo -e "${RED}No active Claude session found.${NC}"
        echo "Start Hyperion with: hyperion start"
    fi
}

cmd_inbox() {
    print_header "Inbox"

    local count=$(count_files "$INBOX_DIR")

    if [ "$count" -eq 0 ]; then
        echo -e "${GREEN}ðŸ“­ Inbox is empty${NC}"
    else
        echo -e "${YELLOW}ðŸ“¬ $count message(s) pending:${NC}"
        echo ""
        for f in "$INBOX_DIR"/*.json; do
            if [ -f "$f" ]; then
                local source=$(jq -r '.source // "unknown"' "$f" 2>/dev/null)
                local user=$(jq -r '.user_name // .username // "unknown"' "$f" 2>/dev/null)
                local text=$(jq -r '.text // "(no text)"' "$f" 2>/dev/null | head -c 60)
                local ts=$(jq -r '.timestamp // ""' "$f" 2>/dev/null | cut -d'T' -f2 | cut -d'.' -f1)
                echo -e "  ${CYAN}[$source]${NC} $user ($ts): $text"
            fi
        done
    fi
}

cmd_outbox() {
    print_header "Outbox"

    local count=$(count_files "$OUTBOX_DIR")

    if [ "$count" -eq 0 ]; then
        echo -e "${GREEN}ðŸ“¤ Outbox is empty${NC}"
    else
        echo -e "${YELLOW}ðŸ“¤ $count reply(s) queued:${NC}"
        echo ""
        for f in "$OUTBOX_DIR"/*.json; do
            if [ -f "$f" ]; then
                local source=$(jq -r '.source // "unknown"' "$f" 2>/dev/null)
                local chat_id=$(jq -r '.chat_id // "?"' "$f" 2>/dev/null)
                local text=$(jq -r '.text // "(no text)"' "$f" 2>/dev/null | head -c 60)
                echo -e "  ${CYAN}[$source]${NC} â†’ $chat_id: $text"
            fi
        done
    fi
}

cmd_stats() {
    print_header "Message Statistics"

    echo ""
    echo -e "${CYAN}Counts:${NC}"
    echo "  Inbox:     $(count_files "$INBOX_DIR") pending"
    echo "  Outbox:    $(count_files "$OUTBOX_DIR") queued"
    echo "  Processed: $(count_files "$PROCESSED_DIR") total"

    echo ""
    echo -e "${CYAN}By Source (processed):${NC}"
    if [ -d "$PROCESSED_DIR" ]; then
        for f in "$PROCESSED_DIR"/*.json; do
            [ -f "$f" ] && jq -r '.source // "unknown"' "$f" 2>/dev/null
        done | sort | uniq -c | sed 's/^/  /'
    else
        echo "  (no data)"
    fi

    echo ""
    echo -e "${CYAN}Recent Activity:${NC}"
    sudo journalctl -u hyperion-claude --since "1 hour ago" --no-pager 2>/dev/null | \
        grep -E "message|processed|reply" | tail -5 | sed 's/^/  /' || echo "  (no recent activity)"
}

cmd_test() {
    print_header "Test Message"

    echo "Creating test message in inbox..."

    local msg_id="test_$(date +%s)"
    local msg_file="$INBOX_DIR/${msg_id}.json"

    cat > "$msg_file" << EOF
{
  "id": "$msg_id",
  "source": "test",
  "chat_id": 0,
  "user_id": 0,
  "username": "test_user",
  "user_name": "Test",
  "text": "This is a test message. Please acknowledge.",
  "timestamp": "$(date -Iseconds)"
}
EOF

    echo -e "${GREEN}âœ“ Test message created: $msg_file${NC}"
    echo ""
    echo "If Claude is running, it should process this shortly."
    echo "Watch with: hyperion attach"
}

cmd_ps() {
    print_header "Claude Instances"

    echo ""

    # Collect claude processes (exclude grep itself and this ps command)
    local pids=()
    local roles=()
    local uptimes=()
    local cmds=()
    local count=0

    while IFS= read -r line; do
        local pid=$(echo "$line" | awk '{print $2}')
        local start_time=$(echo "$line" | awk '{print $9}')
        local cmd=$(echo "$line" | awk '{for(i=11;i<=NF;i++) printf "%s ", $i; print ""}' | sed 's/ $//')

        # Determine role
        local role="interactive"
        if echo "$cmd" | grep -q -- '--dangerously-skip-permissions'; then
            # Check if running in the lobster tmux session
            local tmux_check=$(tmux -L lobster list-panes -a -F '#{pane_pid}' 2>/dev/null || true)
            # Walk up parent pids to see if any ancestor is a tmux pane
            local check_pid=$pid
            local is_main=false
            for _ in 1 2 3 4 5; do
                if echo "$tmux_check" | grep -qw "$check_pid"; then
                    is_main=true
                    break
                fi
                check_pid=$(ps -o ppid= -p "$check_pid" 2>/dev/null | tr -d ' ')
                [ -z "$check_pid" ] && break
            done
            if $is_main; then
                role="main"
            fi
        fi
        if echo "$cmd" | grep -q -- '--max-turns'; then
            role="scheduled"
        fi
        # Check if parent is run-job.sh
        local ppid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
        if [ -n "$ppid" ]; then
            local parent_cmd=$(ps -o args= -p "$ppid" 2>/dev/null || true)
            if echo "$parent_cmd" | grep -q 'run-job.sh'; then
                role="scheduled"
            fi
        fi

        # Calculate uptime from process elapsed time
        local elapsed=$(ps -o etimes= -p "$pid" 2>/dev/null | tr -d ' ')
        local uptime_str=""
        if [ -n "$elapsed" ] && [ "$elapsed" -gt 0 ] 2>/dev/null; then
            local days=$((elapsed / 86400))
            local hours=$(( (elapsed % 86400) / 3600 ))
            local mins=$(( (elapsed % 3600) / 60 ))
            if [ "$days" -gt 0 ]; then
                uptime_str="${days}d ${hours}h ${mins}m"
            elif [ "$hours" -gt 0 ]; then
                uptime_str="${hours}h ${mins}m"
            else
                uptime_str="${mins}m"
            fi
        else
            uptime_str="?"
        fi

        # Truncate command for display
        local cmd_short=$(echo "$cmd" | cut -c1-50)
        [ ${#cmd} -gt 50 ] && cmd_short="${cmd_short}..."

        pids+=("$pid")
        roles+=("$role")
        uptimes+=("$uptime_str")
        cmds+=("$cmd_short")
        count=$((count + 1))
    done < <(ps aux | awk '$11 ~ /(^|\/)claude$/' | grep -v "hyperion ps\|lobster ps")

    if [ "$count" -eq 0 ]; then
        echo -e "  ${YELLOW}No Claude instances running${NC}"
    else
        # Print table header
        printf "  ${CYAN}%-8s %-13s %-10s %s${NC}\n" "PID" "ROLE" "UPTIME" "COMMAND"
        for i in $(seq 0 $((count - 1))); do
            local role_color=""
            case "${roles[$i]}" in
                main)        role_color="${GREEN}" ;;
                scheduled)   role_color="${YELLOW}" ;;
                interactive) role_color="${BLUE}" ;;
            esac
            printf "  %-8s ${role_color}%-13s${NC} %-10s %s\n" "${pids[$i]}" "${roles[$i]}" "${uptimes[$i]}" "${cmds[$i]}"
        done
    fi

    echo ""
    echo "$count Claude instance(s) running"
}

cmd_update() {
    local args=("$@")
    local script="$HOME/hyperion/scripts/update-hyperion.sh"

    if [ ! -f "$script" ]; then
        echo -e "${RED}Error: Update script not found at $script${NC}"
        exit 1
    fi

    # Pass all arguments through to the update script
    exec "$script" "${args[@]}"
}

cmd_help() {
    echo -e "${BLUE}Hyperion CLI${NC} - Unified control for Hyperion message processing"
    echo ""
    echo "Usage: hyperion <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start           Start all Hyperion services"
    echo "  stop            Stop all Hyperion services"
    echo "  restart         Restart all Hyperion services"
    echo "  status          Show status of all components"
    echo "  attach          Attach to Claude tmux session"
    echo "  logs [service]  Show logs (all|bot|claude)"
    echo "  inbox           Check inbox for pending messages"
    echo "  outbox          Check outbox for pending replies"
    echo "  stats           Show message statistics"
    echo "  ps              List running Claude instances"
    echo "  test            Create a test message in inbox"
    echo "  update [opts]   Update Hyperion from git"
    echo "  help            Show this help message"
    echo ""
    echo "Update options:"
    echo "  --check         Check for updates without applying"
    echo "  --force         Continue even if health checks fail"
    echo "  --skip-claude   Skip Claude CLI update"
    echo "  --dry-run       Show what would happen"
    echo "  --rollback      Restore from backup"
    echo ""
    echo "Examples:"
    echo "  hyperion start          # Start everything"
    echo "  hyperion status         # Check what's running"
    echo "  hyperion attach         # View Claude live session"
    echo "  hyperion inbox          # See pending messages"
}

#-------------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------------

case "${1:-help}" in
    start)   cmd_start ;;
    stop)    cmd_stop ;;
    restart) cmd_restart ;;
    status)  cmd_status ;;
    attach)  cmd_attach ;;
    logs)    cmd_logs "$2" ;;
    inbox)   cmd_inbox ;;
    outbox)  cmd_outbox ;;
    stats)   cmd_stats ;;
    ps)      cmd_ps ;;
    test)    cmd_test ;;
    update)  shift; cmd_update "$@" ;;
    help|--help|-h) cmd_help ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'hyperion help' for usage."
        exit 1
        ;;
esac
